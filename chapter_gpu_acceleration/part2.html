<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    <title>6.2. Part 2 &#8212; Machine Learing Compilation 0.0.1 documentation</title>

    <link rel="stylesheet" href="../_static/material-design-lite-1.3.0/material.blue-deep_orange.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx_materialdesign_theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/fontawesome/all.css" type="text/css" />
    <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/d2l.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/d2l.js"></script>
    <link rel="shortcut icon" href="../_static/mlc-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7. Computational Graph Optimization" href="../chapter_graph_optimization/index.html" />
    <link rel="prev" title="6.1. Part 1" href="part1.html" /> 
  </head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer"><header class="mdl-layout__header mdl-layout__header--waterfall ">
    <div class="mdl-layout__header-row">
        
        <nav class="mdl-navigation breadcrumb">
            <a class="mdl-navigation__link" href="index.html"><span class="section-number">6. </span>GPU and Hardware Acceleration</a><i class="material-icons">navigate_next</i>
            <a class="mdl-navigation__link is-active"><span class="section-number">6.2. </span>Part 2</a>
        </nav>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
        
<form class="form-inline pull-sm-right" action="../search.html" method="get">
      <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right">
        <label id="quick-search-icon" class="mdl-button mdl-js-button mdl-button--icon"  for="waterfall-exp">
          <i class="material-icons">search</i>
        </label>
        <div class="mdl-textfield__expandable-holder">
          <input class="mdl-textfield__input" type="text" name="q"  id="waterfall-exp" placeholder="Search" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </div>
      </div>
      <div class="mdl-tooltip" data-mdl-for="quick-search-icon">
      Quick search
      </div>
</form>
        
<a id="button-show-source"
    class="mdl-button mdl-js-button mdl-button--icon"
    href="../_sources/chapter_gpu_acceleration/part2.rst.txt" rel="nofollow">
  <i class="material-icons">code</i>
</a>
<div class="mdl-tooltip" data-mdl-for="button-show-source">
Show Source
</div>
        </nav>
    </div>
    <div class="mdl-layout__header-row header-links">
      <div class="mdl-layout-spacer"></div>
      <nav class="mdl-navigation">
          
              <a  class="mdl-navigation__link" href="https://mlc.ai/summer22">
                  <i class="fas fa-user-graduate"></i>
                  Course
              </a>
          
              <a  class="mdl-navigation__link" href="https://github.com/mlc-ai/mlc-en">
                  <i class="fab fa-github"></i>
                  GitHub
              </a>
          
              <a  class="mdl-navigation__link" href="https://mlc.ai/zh">
                  <i class="fas fa-external-link-alt"></i>
                  中文版
              </a>
      </nav>
    </div>
</header><header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="../index.html">
              <img class="logo" src="../_static/mlc-logo-with-text-landscape.svg" alt="Machine Learing Compilation"/>
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../chapter_introduction/index.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_tensor_program/index.html">2. Tensor Program Abstraction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensor_program.html">2.1. Primitive Tensor Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensor_program.html#tensor-program-abstraction">2.2. Tensor Program Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensor_program.html#summary">2.3. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/case_study.html">2.4. TensorIR: Tensor Program Abstraction Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensorir_exercises.html">2.5. Exercises for TensorIR</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_end_to_end/index.html">3. End to End Model Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_auto_program_optimization/index.html">4. Automatic Program Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_integration/index.html">5. Integration with Machine Learning Frameworks</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">6. GPU and Hardware Acceleration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="part1.html">6.1. Part 1</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.2. Part 2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_graph_optimization/index.html">7. Computational Graph Optimization</a></li>
</ul>

            </nav>
        
        </div>
    
</header>
        <main class="mdl-layout__content" tabIndex="0">

	<script type="text/javascript" src="../_static/sphinx_materialdesign_theme.js "></script>
    <header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="../index.html">
              <img class="logo" src="../_static/mlc-logo-with-text-landscape.svg" alt="Machine Learing Compilation"/>
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../chapter_introduction/index.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_tensor_program/index.html">2. Tensor Program Abstraction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensor_program.html">2.1. Primitive Tensor Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensor_program.html#tensor-program-abstraction">2.2. Tensor Program Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensor_program.html#summary">2.3. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/case_study.html">2.4. TensorIR: Tensor Program Abstraction Case Study</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_tensor_program/tensorir_exercises.html">2.5. Exercises for TensorIR</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_end_to_end/index.html">3. End to End Model Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_auto_program_optimization/index.html">4. Automatic Program Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_integration/index.html">5. Integration with Machine Learning Frameworks</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">6. GPU and Hardware Acceleration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="part1.html">6.1. Part 1</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.2. Part 2</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_graph_optimization/index.html">7. Computational Graph Optimization</a></li>
</ul>

            </nav>
        
        </div>
    
</header>

    <div class="document">
        <div class="page-content" role="main">
        
  <div class="section" id="part-2">
<h1><span class="section-number">6.2. </span>Part 2<a class="headerlink" href="#part-2" title="Permalink to this heading">¶</a></h1>
<p>We discussed building MLC flows for CPU and GPU environments in the past
chapters. This chapter focuses on how we build conceptual programming
models for specialized hardware backends.</p>
<div class="section" id="preparations">
<h2><span class="section-number">6.2.1. </span>Preparations<a class="headerlink" href="#preparations" title="Permalink to this heading">¶</a></h2>
<p>To begin with, let us import the necessary dependencies.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tvm</span>
<span class="kn">from</span> <span class="nn">tvm</span> <span class="kn">import</span> <span class="n">relax</span>
<span class="kn">from</span> <span class="nn">tvm.ir.module</span> <span class="kn">import</span> <span class="n">IRModule</span>
<span class="kn">from</span> <span class="nn">tvm.script</span> <span class="kn">import</span> <span class="n">relax</span> <span class="k">as</span> <span class="n">R</span>
<span class="kn">from</span> <span class="nn">tvm.script</span> <span class="kn">import</span> <span class="n">tir</span> <span class="k">as</span> <span class="n">T</span>
</pre></div>
</div>
</div>
<div class="section" id="hardware-specialization-trend">
<h2><span class="section-number">6.2.2. </span>Hardware Specialization Trend<a class="headerlink" href="#hardware-specialization-trend" title="Permalink to this heading">¶</a></h2>
<div class="figure align-default">
<img alt="../_images/hardware_specialization.png" src="../_images/hardware_specialization.png" />
</div>
<p>If we look at the machine learning hardware landscape, one emerging
theme recently is specialization. Traditionally, we build our solutions
on generic scalar processors, where we can perform operations on one
floating point at a time. The vector instructions set such as AVX and
ARM/Neon provide effective ways to speed up our programs but also bring
some complexities to how we write the programs.</p>
<p>The latest accelerators for machine learning introduced specialized
units for tensor computing, with instructions for multi-dimensional data
copy and matrix/tensor computations.</p>
<div class="section" id="key-elements-of-specialized-code">
<h3><span class="section-number">6.2.2.1. </span>Key Elements of Specialized Code<a class="headerlink" href="#key-elements-of-specialized-code" title="Permalink to this heading">¶</a></h3>
<p>To help us better understand elements of specialized hardware
programming, let us first study the following <strong>low-level NumPy</strong> code.
While this code still runs in python, it resembles a set of possible
operations that can happen in a specialized hardware backend.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">accel_fill_zero</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    <span class="n">C</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">accel_tmm_add</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="n">C</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span>

<span class="k">def</span> <span class="nf">accel_dma_copy</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">dram</span><span class="p">):</span>
    <span class="n">reg</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">dram</span><span class="p">[:]</span>

<span class="k">def</span> <span class="nf">lnumpy_tmm</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">B</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="c1"># a special accumulator memory</span>
    <span class="n">C_accumulator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">A_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">B_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">):</span>
            <span class="n">accel_fill_zero</span><span class="p">(</span><span class="n">C_accumulator</span><span class="p">[:,:])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">):</span>
                <span class="n">accel_dma_copy</span><span class="p">(</span><span class="n">A_reg</span><span class="p">[:],</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">])</span>
                <span class="n">accel_dma_copy</span><span class="p">(</span><span class="n">B_reg</span><span class="p">[:],</span> <span class="n">B</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">])</span>
                <span class="n">accel_tmm_add</span><span class="p">(</span><span class="n">C_accumulator</span><span class="p">[:,:],</span> <span class="n">A_reg</span><span class="p">,</span> <span class="n">B_reg</span><span class="p">)</span>
            <span class="n">accel_dma_copy</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">C_accumulator</span><span class="p">[:,:])</span>
</pre></div>
</div>
<div class="figure align-default">
<img alt="../_images/hardware_specialization_abc.png" src="../_images/hardware_specialization_abc.png" />
</div>
<p>The above low-level NumPy program contains the following key elements:</p>
<ul class="simple">
<li><p>The basic unit of computation is a 16x16x16 matrix multiplication
(<code class="docutils literal notranslate"><span class="pre">accel_tmm_add</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accel_tmm_add</span></code> takes in two inputs – <code class="docutils literal notranslate"><span class="pre">A_reg</span></code> and <code class="docutils literal notranslate"><span class="pre">B_reg</span></code> and
accumulates into an accumulator memory.</p></li>
<li><p>The data copy is performed using a special function
(<code class="docutils literal notranslate"><span class="pre">accel_dma_copy</span></code>).</p></li>
</ul>
<p>In a real-world hardware backend, we usually expect <code class="docutils literal notranslate"><span class="pre">A_reg</span></code>,
<code class="docutils literal notranslate"><span class="pre">B_reg</span></code>, and <code class="docutils literal notranslate"><span class="pre">C_accumulator</span></code> to map to special memory regions (or
registers) in the hardware. These are called <strong>special memory scopes</strong>.
Additionally, there is a limited set of hardware-accelerated operations
we can perform on these settings. Operations such <code class="docutils literal notranslate"><span class="pre">accel_tmm_add</span></code> can
be mapped to real hardware instructions or an efficient kernel function
implementation provided by the vendor.</p>
<p>We can run the following code block to confirm the low-level NumPy code
runs correctly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span>
<span class="n">a_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">b_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">c_tmm</span> <span class="o">=</span> <span class="n">a_np</span> <span class="o">@</span> <span class="n">b_np</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">lnumpy_tmm</span><span class="p">(</span><span class="n">a_np</span><span class="p">,</span> <span class="n">b_np</span><span class="p">,</span> <span class="n">c_np</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">c_np</span><span class="p">,</span> <span class="n">c_tmm</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="a-block-with-tensorized-computation">
<h3><span class="section-number">6.2.2.2. </span>A Block with Tensorized Computation<a class="headerlink" href="#a-block-with-tensorized-computation" title="Permalink to this heading">¶</a></h3>
<p>One of our key observations is that the specialized accelerator code is
not structured in the unit of scalar computations. Most of the TensorIR
code we have run so far contains a block that computes a single element
in the output Tensor. Many specialized accelerators run computations
over regions of tensors. The block construct in TensorIR helps us to
group such relevant computation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tvm</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">ir_module</span>
<span class="k">class</span> <span class="nc">MatmulBlockModule</span><span class="p">:</span>
    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
        <span class="n">A</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
        <span class="n">B</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
        <span class="n">C</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">T</span><span class="o">.</span><span class="n">func_attr</span><span class="p">({</span><span class="s2">&quot;global_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;tir.noalias&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;tmm-16x16&quot;</span><span class="p">):</span>
                <span class="n">vi0</span><span class="p">,</span> <span class="n">vj0</span><span class="p">,</span> <span class="n">vk0</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SSR&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">k0</span><span class="p">])</span>
                <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">init</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;tmm_init&quot;</span><span class="p">):</span>
                            <span class="n">vi1</span><span class="p">,</span> <span class="n">vj1</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">])</span>
                            <span class="n">C</span><span class="p">[</span><span class="n">vi0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">vi1</span><span class="p">,</span> <span class="n">vj0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">vj1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;tmm&quot;</span><span class="p">):</span>
                        <span class="n">vi1</span><span class="p">,</span> <span class="n">vj1</span><span class="p">,</span> <span class="n">vk1</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SSR&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">])</span>
                        <span class="n">C</span><span class="p">[</span><span class="n">vi0</span> <span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="n">vi1</span><span class="p">,</span> <span class="n">vj0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">vj1</span><span class="p">]</span> <span class="o">+=</span> \
                            <span class="n">A</span><span class="p">[</span><span class="n">vi0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">vi1</span><span class="p">,</span> <span class="n">vk0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">vk1</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">vj0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">vj1</span><span class="p">,</span> <span class="n">vk0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">vk1</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MatmulBlockModule</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight" style="background: "><pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), C: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">&quot;tir.noalias&quot;</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block(&quot;root&quot;):</span>
        <span style="color: #008000; font-weight: bold">for</span> i0, j0, k0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">64</span>, <span style="color: #008000">64</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;tmm-16x16&quot;</span>):
                vi0, vj0, vk0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i0, j0, k0])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], B[vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    <span style="color: #008000; font-weight: bold">for</span> i1, j1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;tmm_init&quot;</span>):
                            vi1, vj1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i1, j1])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1])
                            C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0</span>)
                <span style="color: #008000; font-weight: bold">for</span> i1, j1, k1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;tmm&quot;</span>):
                        vi1, vj1, vk1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i1, j1, k1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1], A[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1], B[vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1])
                        C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1] <span style="color: #AA22FF; font-weight: bold">=</span> C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1] <span style="color: #AA22FF; font-weight: bold">+</span> A[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1] <span style="color: #AA22FF; font-weight: bold">*</span> B[vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1]
</pre></div><p>Let us take a closer look at the following block</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;tmm-16x16&quot;</span><span class="p">):</span>
    <span class="n">T</span><span class="o">.</span><span class="n">reads</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">vi0</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">vi0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">vk0</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">vk0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">],</span> <span class="n">B</span><span class="p">[</span><span class="n">vj0</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">vj0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">vk0</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">vk0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">])</span>
    <span class="n">T</span><span class="o">.</span><span class="n">writes</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">vi0</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">vi0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">vj0</span> <span class="o">*</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">vj0</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">16</span><span class="p">])</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This block reads from a 16x16 region from <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code>, and writes to
a 16x16 region of <code class="docutils literal notranslate"><span class="pre">C</span></code>. In this case the content of the block contains
further details about a specific implementation of the subregion
computations. We call this block a <strong>tensorized block</strong> as they contain
computations that span over sub-regions of tensors.</p>
<p>We can run the following code to confirm that the TensorIR module
produces the correct result.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a_nd</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_np</span><span class="p">)</span>
<span class="n">b_nd</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b_np</span><span class="p">)</span>

<span class="n">c_nd</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

<span class="n">lib</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">MatmulBlockModule</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;llvm&quot;</span><span class="p">)</span>
<span class="n">lib</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">](</span><span class="n">a_nd</span><span class="p">,</span> <span class="n">b_nd</span><span class="p">,</span> <span class="n">c_nd</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">c_nd</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">c_tmm</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="transforming-loops-around-tensorized-block">
<h3><span class="section-number">6.2.2.3. </span>Transforming Loops Around Tensorized Block<a class="headerlink" href="#transforming-loops-around-tensorized-block" title="Permalink to this heading">¶</a></h3>
<p>One thing that we can do here is to transform the loops surrounding the
tensor computation block. These loop transformations can help us to
reorganize the surrounding iterations to enable a space of different
tensor program variants.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sch</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">Schedule</span><span class="p">(</span><span class="n">MatmulBlockModule</span><span class="p">)</span>

<span class="n">block_mm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="s2">&quot;tmm-16x16&quot;</span><span class="p">)</span>
<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">get_loops</span><span class="p">(</span><span class="n">block_mm</span><span class="p">)</span>

<span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="n">sch</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight" style="background: "><pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), C: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">&quot;tir.noalias&quot;</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block(&quot;root&quot;):</span>
        <span style="color: #008000; font-weight: bold">for</span> i0_0, j0, i0_1, k0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">64</span>, <span style="color: #008000">4</span>, <span style="color: #008000">64</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;tmm-16x16&quot;</span>):
                vi0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">64</span>, i0_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">4</span> <span style="color: #AA22FF; font-weight: bold">+</span> i0_1)
                vj0, vk0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SR&quot;</span>, [j0, k0])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], B[vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    <span style="color: #008000; font-weight: bold">for</span> i1, j1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;tmm_init&quot;</span>):
                            vi1, vj1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i1, j1])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1])
                            C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0</span>)
                <span style="color: #008000; font-weight: bold">for</span> i1, j1, k1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;tmm&quot;</span>):
                        vi1, vj1, vk1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i1, j1, k1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1], A[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1], B[vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1])
                        C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1] <span style="color: #AA22FF; font-weight: bold">=</span> C[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1] <span style="color: #AA22FF; font-weight: bold">+</span> A[vi0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1] <span style="color: #AA22FF; font-weight: bold">*</span> B[vj0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj1, vk0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk1]
</pre></div></div>
<div class="section" id="blockization-creating-tensorized-blocks">
<h3><span class="section-number">6.2.2.4. </span>Blockization – Creating Tensorized Blocks<a class="headerlink" href="#blockization-creating-tensorized-blocks" title="Permalink to this heading">¶</a></h3>
<p>In most settings, we start with loops that come with scalar
computations. TensorIR provides a primitive call blockization to group
subregions of a loop together to form a tensorized computation block.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tvm</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">ir_module</span>
<span class="k">class</span> <span class="nc">MatmulModule</span><span class="p">:</span>
    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
        <span class="n">A</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
        <span class="n">B</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
        <span class="n">C</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">T</span><span class="o">.</span><span class="n">func_attr</span><span class="p">({</span><span class="s2">&quot;global_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;tir.noalias&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;matmul&quot;</span><span class="p">):</span>
                <span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">,</span> <span class="n">vk</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SSR&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
                <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">init</span><span class="p">():</span>
                    <span class="n">C</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">C</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">vi</span><span class="p">,</span> <span class="n">vk</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">vj</span><span class="p">,</span> <span class="n">vk</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sch</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">Schedule</span><span class="p">(</span><span class="n">MatmulModule</span><span class="p">)</span>
<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">get_loops</span><span class="p">(</span><span class="s2">&quot;matmul&quot;</span><span class="p">)</span>
<span class="n">i</span><span class="p">,</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
<span class="n">j</span><span class="p">,</span> <span class="n">ji</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
<span class="n">k</span><span class="p">,</span> <span class="n">ki</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
<span class="n">sch</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ji</span><span class="p">,</span> <span class="n">ki</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight" style="background: "><pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), C: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">&quot;tir.noalias&quot;</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block(&quot;root&quot;):</span>
        <span style="color: #008000; font-weight: bold">for</span> i_0, j_0, k_0, i_1, j_1, k_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">64</span>, <span style="color: #008000">64</span>, <span style="color: #008000">16</span>, <span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul&quot;</span>):
                vi <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, i_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> i_1)
                vj <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, j_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> j_1)
                vk <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>reduce(<span style="color: #008000">1024</span>, k_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> k_1)
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[vi, vk], B[vj, vk])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi, vj])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    C[vi, vj] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0</span>)
                C[vi, vj] <span style="color: #AA22FF; font-weight: bold">=</span> C[vi, vj] <span style="color: #AA22FF; font-weight: bold">+</span> A[vi, vk] <span style="color: #AA22FF; font-weight: bold">*</span> B[vj, vk]
</pre></div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">block_mm</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">blockize</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight" style="background: "><pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), C: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">&quot;tir.noalias&quot;</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block(&quot;root&quot;):</span>
        <span style="color: #008000; font-weight: bold">for</span> i_0, j_0, k_0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">64</span>, <span style="color: #008000">64</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_o&quot;</span>):
                vi_o, vj_o, vk_o <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i_0, j_0, k_0])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], B[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                    <span style="color: #008000; font-weight: bold">for</span> i_1, j_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_init&quot;</span>):
                            vi_i_init, vj_i_init <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i_1, j_1])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init])
                            C[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0</span>)
                <span style="color: #008000; font-weight: bold">for</span> i_1, j_1, k_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul&quot;</span>):
                        vi_i, vj_i, vk_i <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i_1, j_1, k_1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i], A[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i], B[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i])
                        C[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i] <span style="color: #AA22FF; font-weight: bold">=</span> C[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i] <span style="color: #AA22FF; font-weight: bold">+</span> A[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i] <span style="color: #AA22FF; font-weight: bold">*</span> B[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i]
</pre></div></div>
<div class="section" id="transforming-tensorir-to-introduce-special-memory-scope">
<h3><span class="section-number">6.2.2.5. </span>Transforming TensorIR to Introduce Special Memory Scope<a class="headerlink" href="#transforming-tensorir-to-introduce-special-memory-scope" title="Permalink to this heading">¶</a></h3>
<p>As we noted in the low-level NumPy code, one key element of the
low-level TensorIR is the special memory scope used during the
acceleration.</p>
<p>We can use cache_read and write to create intermediate memory stages.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">A_reg</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">cache_read</span><span class="p">(</span><span class="n">block_mm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">storage_scope</span><span class="o">=</span><span class="s2">&quot;global.A_reg&quot;</span><span class="p">)</span>
<span class="n">B_reg</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">cache_read</span><span class="p">(</span><span class="n">block_mm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">storage_scope</span><span class="o">=</span><span class="s2">&quot;global.B_reg&quot;</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">compute_at</span><span class="p">(</span><span class="n">A_reg</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">compute_at</span><span class="p">(</span><span class="n">B_reg</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

<span class="n">write_back_block</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">cache_write</span><span class="p">(</span><span class="n">block_mm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">storage_scope</span><span class="o">=</span><span class="s2">&quot;global.accumulator&quot;</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">reverse_compute_at</span><span class="p">(</span><span class="n">write_back_block</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight" style="background: "><pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), C: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">&quot;tir.noalias&quot;</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block(&quot;root&quot;):</span>
        A_global_A_reg <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.A_reg&quot;</span>)
        B_global_B_reg <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.B_reg&quot;</span>)
        C_global_accumulator <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.accumulator&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> i_0, j_0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">64</span>):
            <span style="color: #008000; font-weight: bold">for</span> k_0 <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">64</span>):
                <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;A_global.A_reg&quot;</span>):
                        v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, i_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                        v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, k_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v0, v1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(A_global_A_reg[v0, v1])
                        A_global_A_reg[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> A[v0, v1]
                <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;B_global.B_reg&quot;</span>):
                        v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, j_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                        v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, k_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(B[v0, v1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(B_global_B_reg[v0, v1])
                        B_global_B_reg[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> B[v0, v1]
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_o&quot;</span>):
                    vi_o, vj_o, vk_o <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i_0, j_0, k_0])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>init():
                        <span style="color: #008000; font-weight: bold">for</span> i_1, j_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_init&quot;</span>):
                                vi_i_init, vj_i_init <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i_1, j_1])
                                T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init])
                                C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0</span>)
                    <span style="color: #008000; font-weight: bold">for</span> i_1, j_1, k_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul&quot;</span>):
                            vi_i, vj_i, vk_i <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i_1, j_1, k_1])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i], A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i], B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i])
                            C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i] <span style="color: #AA22FF; font-weight: bold">=</span> C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i] <span style="color: #AA22FF; font-weight: bold">+</span> A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i] <span style="color: #AA22FF; font-weight: bold">*</span> B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i]
            <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;C_global.accumulator&quot;</span>):
                    v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, i_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                    v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, j_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C_global_accumulator[v0, v1])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v0, v1])
                    C[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> C_global_accumulator[v0, v1]
</pre></div><div class="figure align-default">
<img alt="../_images/hardware_specialization_abc.png" src="../_images/hardware_specialization_abc.png" />
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">global.A_reg</span></code> contains two parts. <code class="docutils literal notranslate"><span class="pre">global</span></code> indicates that all
threads can globally access the memory, and <code class="docutils literal notranslate"><span class="pre">A_reg</span></code> is a <strong>scope tag</strong>
of the memory, which provides opportunities for follow-up compilation to
map it to special regions such as registers.</p>
</div>
</div>
<div class="section" id="tensorization">
<h2><span class="section-number">6.2.3. </span>Tensorization<a class="headerlink" href="#tensorization" title="Permalink to this heading">¶</a></h2>
<p>Now we have created a set of blocks that maps to the corresponding
stages of computation in the TensorIR. The remaining step is to map some
of the tensorized blocks to use a specific implementation that maps to
the hardware accelerated instructions. This mapping process is called
<strong>tensorization</strong>.</p>
<p>To prepare for tensorization, we first register a tensor intrinsic
(TensorIntrin) that contains a description of the computation and
implementation.</p>
<p>The system will use the description to find relevant regions that match
the computation, while implementation maps the computation to
accelerated hardware instructions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
<span class="k">def</span> <span class="nf">tmm16_desc</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">offset_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;global.A_reg&quot;</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">offset_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;global.B_reg&quot;</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">offset_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;global.accumulator&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">):</span>
        <span class="n">T</span><span class="o">.</span><span class="n">reads</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
        <span class="n">T</span><span class="o">.</span><span class="n">writes</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">vii</span><span class="p">,</span> <span class="n">vjj</span><span class="p">,</span> <span class="n">vkk</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="s2">&quot;SSR&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
                <span class="n">C</span><span class="p">[</span><span class="n">vii</span><span class="p">,</span> <span class="n">vjj</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">vii</span><span class="p">,</span> <span class="n">vjj</span><span class="p">]</span> <span class="o">+</span> <span class="n">A</span><span class="p">[</span><span class="n">vii</span><span class="p">,</span> <span class="n">vkk</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">vjj</span><span class="p">,</span> <span class="n">vkk</span><span class="p">]</span>


<span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
<span class="k">def</span> <span class="nf">tmm16_impl</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">int32</span><span class="p">()</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">int32</span><span class="p">()</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">int32</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">offset_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="n">sa</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;global.A_reg&quot;</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">offset_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;global.B_reg&quot;</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">match_buffer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">offset_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;global.accumulator&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">):</span>
        <span class="n">T</span><span class="o">.</span><span class="n">reads</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
        <span class="n">T</span><span class="o">.</span><span class="n">writes</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
        <span class="n">T</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="n">T</span><span class="o">.</span><span class="n">call_extern</span><span class="p">(</span>
                <span class="s2">&quot;tmm16&quot;</span><span class="p">,</span>
                <span class="n">C</span><span class="o">.</span><span class="n">access_ptr</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">),</span>
                <span class="n">A</span><span class="o">.</span><span class="n">access_ptr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                <span class="n">B</span><span class="o">.</span><span class="n">access_ptr</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">),</span>
                <span class="n">sa</span><span class="p">,</span>
                <span class="n">sb</span><span class="p">,</span>
                <span class="n">sc</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

<span class="n">tvm</span><span class="o">.</span><span class="n">tir</span><span class="o">.</span><span class="n">TensorIntrin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;tmm16&quot;</span><span class="p">,</span> <span class="n">tmm16_desc</span><span class="p">,</span> <span class="n">tmm16_impl</span><span class="p">)</span>
</pre></div>
</div>
<p>As a preparation step, we first decompose the reduction into an
initialization block and an update step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sch</span><span class="o">.</span><span class="n">decompose_reduction</span><span class="p">(</span><span class="n">block_mm</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight" style="background: "><pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), C: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">&quot;tir.noalias&quot;</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block(&quot;root&quot;):</span>
        A_global_A_reg <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.A_reg&quot;</span>)
        B_global_B_reg <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.B_reg&quot;</span>)
        C_global_accumulator <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.accumulator&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> i_0, j_0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">64</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_o_init&quot;</span>):
                vi_o, vj_o <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i_0, j_0])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                <span style="color: #008000; font-weight: bold">for</span> i_1, j_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_init&quot;</span>):
                        vi_i_init, vj_i_init <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i_1, j_1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init])
                        C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0</span>)
            <span style="color: #008000; font-weight: bold">for</span> k_0 <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">64</span>):
                <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;A_global.A_reg&quot;</span>):
                        v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, i_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                        v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, k_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v0, v1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(A_global_A_reg[v0, v1])
                        A_global_A_reg[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> A[v0, v1]
                <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;B_global.B_reg&quot;</span>):
                        v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, j_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                        v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, k_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(B[v0, v1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(B_global_B_reg[v0, v1])
                        B_global_B_reg[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> B[v0, v1]
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_o_update&quot;</span>):
                    vi_o, vj_o, vk_o <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i_0, j_0, k_0])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                    <span style="color: #008000; font-weight: bold">for</span> i_1, j_1, k_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                        <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul&quot;</span>):
                            vi_i, vj_i, vk_i <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i_1, j_1, k_1])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i], A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i], B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i])
                            T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i])
                            C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i] <span style="color: #AA22FF; font-weight: bold">=</span> C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i] <span style="color: #AA22FF; font-weight: bold">+</span> A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i] <span style="color: #AA22FF; font-weight: bold">*</span> B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vk_i]
            <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;C_global.accumulator&quot;</span>):
                    v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, i_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                    v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, j_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C_global_accumulator[v0, v1])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v0, v1])
                    C[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> C_global_accumulator[v0, v1]
</pre></div><p>Then we can call tensorize, to map the <code class="docutils literal notranslate"><span class="pre">block_mm</span></code> (which corresponds
to the <code class="docutils literal notranslate"><span class="pre">matmul_o_update</span></code> block) to use the implementation of
<code class="docutils literal notranslate"><span class="pre">tmm16</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sch</span><span class="o">.</span><span class="n">tensorize</span><span class="p">(</span><span class="n">block_mm</span><span class="p">,</span> <span class="s2">&quot;tmm16&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sch</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight" style="background: "><pre style="line-height: 125%;"><span></span><span style="color: #007979; font-style: italic"># from tvm.script import ir as I</span>
<span style="color: #007979; font-style: italic"># from tvm.script import tir as T</span>

<span style="color: #AA22FF">@I</span><span style="color: #AA22FF; font-weight: bold">.</span>ir_module
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Module</span>:
    <span style="color: #AA22FF">@T</span><span style="color: #AA22FF; font-weight: bold">.</span>prim_func
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(A: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), B: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>), C: T<span style="color: #AA22FF; font-weight: bold">.</span>Buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), <span style="color: #BA2121">&quot;float32&quot;</span>)):
        T<span style="color: #AA22FF; font-weight: bold">.</span>func_attr({<span style="color: #BA2121">&quot;tir.noalias&quot;</span>: T<span style="color: #AA22FF; font-weight: bold">.</span>bool(<span style="color: #008000; font-weight: bold">True</span>)})
        <span style="color: #007979; font-style: italic"># with T.block(&quot;root&quot;):</span>
        A_global_A_reg <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.A_reg&quot;</span>)
        B_global_B_reg <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.B_reg&quot;</span>)
        C_global_accumulator <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>alloc_buffer((<span style="color: #008000">1024</span>, <span style="color: #008000">1024</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.accumulator&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> i_0, j_0 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">64</span>, <span style="color: #008000">64</span>):
            <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_o_init&quot;</span>):
                vi_o, vj_o <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i_0, j_0])
                T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                <span style="color: #008000; font-weight: bold">for</span> i_1, j_1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_init&quot;</span>):
                        vi_i_init, vj_i_init <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SS&quot;</span>, [i_1, j_1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads()
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init])
                        C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vi_i_init, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> vj_i_init] <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>float32(<span style="color: #008000">0</span>)
            <span style="color: #008000; font-weight: bold">for</span> k_0 <span style="color: #008000; font-weight: bold">in</span> range(<span style="color: #008000">64</span>):
                <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;A_global.A_reg&quot;</span>):
                        v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, i_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                        v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, k_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(A[v0, v1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(A_global_A_reg[v0, v1])
                        A_global_A_reg[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> A[v0, v1]
                <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                    <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;B_global.B_reg&quot;</span>):
                        v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, j_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                        v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, k_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                        T<span style="color: #AA22FF; font-weight: bold">.</span>reads(B[v0, v1])
                        T<span style="color: #AA22FF; font-weight: bold">.</span>writes(B_global_B_reg[v0, v1])
                        B_global_B_reg[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> B[v0, v1]
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;matmul_o_update&quot;</span>):
                    vi_o, vj_o, vk_o <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>remap(<span style="color: #BA2121">&quot;SSR&quot;</span>, [i_0, j_0, k_0])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>])
                    A_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>match_buffer(A_global_A_reg[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], (<span style="color: #008000">16</span>, <span style="color: #008000">16</span>), strides<span style="color: #AA22FF; font-weight: bold">=</span>(<span style="color: #BA2121">&quot;A_s0&quot;</span>, <span style="color: #008000">1</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.A_reg&quot;</span>, offset_factor<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #008000">16</span>)
                    B_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>match_buffer(B_global_B_reg[vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vk_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], (<span style="color: #008000">16</span>, <span style="color: #008000">16</span>), strides<span style="color: #AA22FF; font-weight: bold">=</span>(<span style="color: #BA2121">&quot;B_s0&quot;</span>, <span style="color: #008000">1</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.B_reg&quot;</span>, offset_factor<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #008000">16</span>)
                    C_1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>match_buffer(C_global_accumulator[vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vi_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>, vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>:vj_o <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> <span style="color: #008000">16</span>], (<span style="color: #008000">16</span>, <span style="color: #008000">16</span>), strides<span style="color: #AA22FF; font-weight: bold">=</span>(<span style="color: #BA2121">&quot;C_s0&quot;</span>, <span style="color: #008000">1</span>), scope<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #BA2121">&quot;global.accumulator&quot;</span>, offset_factor<span style="color: #AA22FF; font-weight: bold">=</span><span style="color: #008000">16</span>)
                    T<span style="color: #AA22FF; font-weight: bold">.</span>call_extern(<span style="color: #BA2121">&quot;int32&quot;</span>, <span style="color: #BA2121">&quot;tmm16&quot;</span>, T<span style="color: #AA22FF; font-weight: bold">.</span>tvm_access_ptr(T<span style="color: #AA22FF; font-weight: bold">.</span>type_annotation(<span style="color: #BA2121">&quot;float32&quot;</span>), C_1<span style="color: #AA22FF; font-weight: bold">.</span>data, C_1<span style="color: #AA22FF; font-weight: bold">.</span>elem_offset, C_1<span style="color: #AA22FF; font-weight: bold">.</span>strides[<span style="color: #008000">0</span>] <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>, <span style="color: #008000">2</span>), T<span style="color: #AA22FF; font-weight: bold">.</span>tvm_access_ptr(T<span style="color: #AA22FF; font-weight: bold">.</span>type_annotation(<span style="color: #BA2121">&quot;float32&quot;</span>), A_1<span style="color: #AA22FF; font-weight: bold">.</span>data, A_1<span style="color: #AA22FF; font-weight: bold">.</span>elem_offset, A_1<span style="color: #AA22FF; font-weight: bold">.</span>strides[<span style="color: #008000">0</span>] <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>, <span style="color: #008000">1</span>), T<span style="color: #AA22FF; font-weight: bold">.</span>tvm_access_ptr(T<span style="color: #AA22FF; font-weight: bold">.</span>type_annotation(<span style="color: #BA2121">&quot;float32&quot;</span>), B_1<span style="color: #AA22FF; font-weight: bold">.</span>data, B_1<span style="color: #AA22FF; font-weight: bold">.</span>elem_offset, B_1<span style="color: #AA22FF; font-weight: bold">.</span>strides[<span style="color: #008000">0</span>] <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span>, <span style="color: #008000">1</span>), A_1<span style="color: #AA22FF; font-weight: bold">.</span>strides[<span style="color: #008000">0</span>], B_1<span style="color: #AA22FF; font-weight: bold">.</span>strides[<span style="color: #008000">0</span>], C_1<span style="color: #AA22FF; font-weight: bold">.</span>strides[<span style="color: #008000">0</span>])
            <span style="color: #008000; font-weight: bold">for</span> ax0, ax1 <span style="color: #008000; font-weight: bold">in</span> T<span style="color: #AA22FF; font-weight: bold">.</span>grid(<span style="color: #008000">16</span>, <span style="color: #008000">16</span>):
                <span style="color: #008000; font-weight: bold">with</span> T<span style="color: #AA22FF; font-weight: bold">.</span>block(<span style="color: #BA2121">&quot;C_global.accumulator&quot;</span>):
                    v0 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, i_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax0)
                    v1 <span style="color: #AA22FF; font-weight: bold">=</span> T<span style="color: #AA22FF; font-weight: bold">.</span>axis<span style="color: #AA22FF; font-weight: bold">.</span>spatial(<span style="color: #008000">1024</span>, j_0 <span style="color: #AA22FF; font-weight: bold">*</span> <span style="color: #008000">16</span> <span style="color: #AA22FF; font-weight: bold">+</span> ax1)
                    T<span style="color: #AA22FF; font-weight: bold">.</span>reads(C_global_accumulator[v0, v1])
                    T<span style="color: #AA22FF; font-weight: bold">.</span>writes(C[v0, v1])
                    C[v0, v1] <span style="color: #AA22FF; font-weight: bold">=</span> C_global_accumulator[v0, v1]
</pre></div><p>Here we use <code class="docutils literal notranslate"><span class="pre">T.call_extern</span></code> to call into an external function inside
the environment. The downstream compilation step can easily map the
implementation to an instruction that implements the operation.</p>
<p>Alternatively, we can map tmm16 to a micro-kernel that implements this
tensorized computation. The following code shows the how to do that
through an extern “C” code (which allows further embedding of inline
assembly if necessary).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tmm_kernel</span><span class="p">():</span>
    <span class="n">cc_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      extern &quot;C&quot; int tmm16(float *cc, float *aa, float *bb, int stride_a, int stride_b, int stride_c) {</span>
<span class="s2">        for (int i = 0; i &lt; 16; ++i) {</span>
<span class="s2">            for (int j = 0; j &lt; 16; ++j) {</span>
<span class="s2">                for (int k = 0; k &lt; 16; ++k) {</span>
<span class="s2">                    cc[i * stride_c + j] += aa[i * stride_a + k] * bb[j * stride_b + k];</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">        return 0;</span>
<span class="s2">      }</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">tvm.contrib</span> <span class="kn">import</span> <span class="n">clang</span><span class="p">,</span> <span class="n">utils</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">tempdir</span><span class="p">()</span>
    <span class="n">ll_path</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="s2">&quot;temp.ll&quot;</span><span class="p">)</span>
    <span class="c1"># Create LLVM ir from c source code</span>
    <span class="n">ll_code</span> <span class="o">=</span> <span class="n">clang</span><span class="o">.</span><span class="n">create_llvm</span><span class="p">(</span><span class="n">cc_code</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">ll_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll_code</span>

<span class="n">sch</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;pragma_import_llvm&quot;</span><span class="p">,</span> <span class="n">tmm_kernel</span><span class="p">())</span>
</pre></div>
</div>
<p>We can then go and execute the following code-block, which redirects the
tensorized computation to the custom defined <code class="docutils literal notranslate"><span class="pre">tmm_kernel</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!-- todo --&gt;
&lt;!-- For CI, do not run this part of the code --&gt;
a_nd = tvm.nd.array(a_np)
b_nd = tvm.nd.array(b_np)

c_nd = tvm.nd.empty((1024, 1024), dtype=&quot;float32&quot;)

lib = tvm.build(sch.mod, target=&quot;llvm&quot;)
lib[&quot;main&quot;](a_nd, b_nd, c_nd)
np.testing.assert_allclose(c_nd.numpy(), c_tmm, rtol=1e-5)
</pre></div>
</div>
</div>
<div class="section" id="discussions">
<h2><span class="section-number">6.2.4. </span>Discussions<a class="headerlink" href="#discussions" title="Permalink to this heading">¶</a></h2>
<p>This section covers a set of key elements of specialized hardware
support. One of the key constructs here is the tensorized block and
computation alongside tensor subregions. TensorIR also contains
additional properties that build on top of the foundational elements:</p>
<ul class="simple">
<li><p>Layout constraints in the specialized memory.</p></li>
<li><p>Interaction with thread hierarchies.</p></li>
</ul>
<p>We don’t have enough time to cover these in one lecture, but we will add
optional readings on some of the additional content.</p>
</div>
<div class="section" id="summary">
<h2><span class="section-number">6.2.5. </span>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Overall trend of Hardware Specialization toward tensorized
computation.</p></li>
<li><p>TensorIR transformations with tensorized blocks.</p></li>
<li><p>Tensorization: the process of mapping block of loop computations to
specialized implementations.</p></li>
</ul>
</div>
</div>


        </div>
        <div class="side-doc-outline">
            <div class="side-doc-outline--content"> 
<div class="localtoc">
    <p class="caption">
      <span class="caption-text">Table Of Contents</span>
    </p>
    <ul>
<li><a class="reference internal" href="#">6.2. Part 2</a><ul>
<li><a class="reference internal" href="#preparations">6.2.1. Preparations</a></li>
<li><a class="reference internal" href="#hardware-specialization-trend">6.2.2. Hardware Specialization Trend</a><ul>
<li><a class="reference internal" href="#key-elements-of-specialized-code">6.2.2.1. Key Elements of Specialized Code</a></li>
<li><a class="reference internal" href="#a-block-with-tensorized-computation">6.2.2.2. A Block with Tensorized Computation</a></li>
<li><a class="reference internal" href="#transforming-loops-around-tensorized-block">6.2.2.3. Transforming Loops Around Tensorized Block</a></li>
<li><a class="reference internal" href="#blockization-creating-tensorized-blocks">6.2.2.4. Blockization – Creating Tensorized Blocks</a></li>
<li><a class="reference internal" href="#transforming-tensorir-to-introduce-special-memory-scope">6.2.2.5. Transforming TensorIR to Introduce Special Memory Scope</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tensorization">6.2.3. Tensorization</a></li>
<li><a class="reference internal" href="#discussions">6.2.4. Discussions</a></li>
<li><a class="reference internal" href="#summary">6.2.5. Summary</a></li>
</ul>
</li>
</ul>

</div>
            </div>
        </div>

      <div class="clearer"></div>
    </div><div class="pagenation">
     <a id="button-prev" href="part1.html" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" role="botton" accesskey="P">
         <i class="pagenation-arrow-L fas fa-arrow-left fa-lg"></i>
         <div class="pagenation-text">
            <span class="pagenation-direction">Previous</span>
            <div>6.1. Part 1</div>
         </div>
     </a>
     <a id="button-next" href="../chapter_graph_optimization/index.html" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" role="botton" accesskey="N">
         <i class="pagenation-arrow-R fas fa-arrow-right fa-lg"></i>
        <div class="pagenation-text">
            <span class="pagenation-direction">Next</span>
            <div>7. Computational Graph Optimization</div>
        </div>
     </a>
  </div>
        
        </main>
    </div>
  </body>
</html>